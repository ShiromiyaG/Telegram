name: Build Telegram Android (Official Source)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Baixa o código do repositório
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Configura o ambiente Java (JDK)
      - name: Set up JDK 17 # O projeto oficial do Telegram requer JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 3. Cria o arquivo google-services.json a partir dos segredos
      - name: Create google-services.json
        run: |
          echo "Creating google-services.json in TMessagesProj/"
          echo "${{ secrets.GOOGLE_SERVICES_BASE64 }}" | base64 --decode > TMessagesProj/google-services.json

      # 4. Cria o arquivo BuildVars.java com os segredos
      #    Caminho e nome de arquivo corrigidos para o projeto oficial
      - name: Create BuildVars.java
        run: |
          echo "package org.telegram.messenger;" > TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
          echo "public class BuildVars {" >> TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
          echo "    public static String APP_HASH = \"${{ secrets.API_HASH }}\";" >> TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
          echo "    public static int APP_ID = ${{ secrets.API_ID }};" >> TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
          echo "    public static boolean isBeta = false;" >> TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
          echo "    public static boolean DEBUG_VERSION = false;" >> TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
          echo "    public static boolean LOGS_ENABLED = false;" >> TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
          echo "    public static boolean DEBUG_PRIVATE_VERSION = false;" >> TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
          echo "}" >> TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
        shell: bash

      # 5. Decodifica e salva o arquivo keystore no local correto
      - name: Decode Keystore
        run: |
          mkdir -p TMessagesProj/config
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 --decode > TMessagesProj/config/release.keystore

      # 6. Concede permissão de execução para o gradlew
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 7. Compila a versão de Release (o build de Debug é gerado automaticamente)
      #    Parâmetros de assinatura injetados de forma segura
      - name: Build Release APK
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=${{ github.workspace }}/TMessagesProj/config/release.keystore \
            -Pandroid.injected.signing.store.password=${{ secrets.RELEASE_KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.RELEASE_KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.RELEASE_KEY_PASSWORD }}

      # 10. Cria uma Release em Rascunho e faz upload dos APKs
      - name: Create Draft Release with APKs
        uses: softprops/action-gh-release@v2
        with:
          # O token é necessário para autenticar na API do GitHub
          token: ${{ secrets.GITHUB_TOKEN }}
          # O nome da tag pode ser dinâmico
          tag_name: build-${{ github.run_number }}
          # O nome da Release
          name: Build ${{ github.run_number }} (${{ github.sha }})
          # A chave para manter a release privada!
          draft: true
          # Informa que é um pré-lançamento, opcional
          prerelease: true
          # Arquivos que serão anexados à release
          files: |
            TMessagesProj/build/outputs/apk/debug/TMessagesProj-debug.apk
            TMessagesProj/build/outputs/apk/release/TMessagesProj-release.apk

      # 8. Faz o upload do APK de Debug como artefato
      # - name: Upload Debug APK
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: telegram-debug-apk
      #     path: TMessagesProj/build/outputs/apk/debug/TMessagesProj-debug.apk

      # 9. Faz o upload do APK de Release como artefato
      # - name: Upload Release APK
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: telegram-release-apk
      #     path: TMessagesProj/build/outputs/apk/release/TMessagesProj-release.apk
